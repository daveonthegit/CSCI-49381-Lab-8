<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netstat Traffic Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
        }
        .chart-container {
            margin: 20px 0;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .chart-half {
            flex: 1 1 calc(50% - 20px);
            min-width: 300px;
        }
        .stats-panel {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat-card {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .analysis {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        .upload-container {
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px dashed #3498db;
        }
        .upload-container.drag-over {
            background-color: #d4e9ff;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .file-name {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
        }
        .hide {
            display: none;
        }
        .sample-data-btn {
            background-color: #95a5a6;
            margin-left: 10px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }
        .no-data-message {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Netstat Traffic Analyzer</h1>
        
        <div class="upload-container" id="upload-area">
            <h2>Upload Netstat Data</h2>
            <p>Upload the JSON file generated by the netstat_parser.py script</p>
            <input type="file" id="fileInput" accept=".json" style="display: none;">
            <button class="btn" id="uploadBtn">Choose File</button>
            <button class="btn sample-data-btn" id="sampleDataBtn">Use Sample Data</button>
            <div id="fileName" class="file-name"></div>
        </div>
        
        <div id="loading" class="loading hide">
            Processing data, please wait...
        </div>
        
        <div id="noDataMessage" class="no-data-message">
            <p>Please upload a JSON file to view network traffic analysis</p>
        </div>
        
        <div id="dataVisualization" class="hide">
            <div class="stats-panel">
                <h2>Summary Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-timestamps">-</div>
                        <div class="stat-label">Timestamps Analyzed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="max-connections">-</div>
                        <div class="stat-label">Max Connections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="max-syn-recv">-</div>
                        <div class="stat-label">Max SYN_RECV Connections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="unique-ips">-</div>
                        <div class="stat-label">Unique IPs</div>
                    </div>
                </div>
            </div>

            <div class="analysis" id="attack-analysis">
                <h3>Attack Analysis</h3>
                <p>Loading analysis...</p>
            </div>
            
            <div class="flex-container">
                <div class="chart-half">
                    <div class="chart-container">
                        <h2>Connection States Over Time</h2>
                        <canvas id="statesChart"></canvas>
                    </div>
                </div>
                <div class="chart-half">
                    <div class="chart-container">
                        <h2>Connections by Port</h2>
                        <canvas id="portsChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="flex-container">
                <div class="chart-half">
                    <div class="chart-container">
                        <h2>HTTP vs SSH Connections</h2>
                        <canvas id="serviceChart"></canvas>
                    </div>
                </div>
                <div class="chart-half">
                    <div class="chart-container">
                        <h2>SYN_RECV States (Potential Attack Indicator)</h2>
                        <canvas id="synRecvChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <h2>Unique Source IPs for Web Traffic</h2>
                <canvas id="uniqueSourcesChart"></canvas>
            </div>
            
            <div>
                <h2>Connection Details</h2>
                <table id="connectionTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Total Connections</th>
                            <th>HTTP Connections</th>
                            <th>SSH Connections</th>
                            <th>SYN_RECV Connections</th>
                            <th>Unique Web Sources</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Chart instances to be destroyed and recreated
        let statesChart, portsChart, serviceChart, synRecvChart, uniqueSourcesChart;
        
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const sampleDataBtn = document.getElementById('sampleDataBtn');
            const fileNameDisplay = document.getElementById('fileName');
            const uploadArea = document.getElementById('upload-area');
            const loadingDisplay = document.getElementById('loading');
            const dataVisualization = document.getElementById('dataVisualization');
            const noDataMessage = document.getElementById('noDataMessage');
            
            // Set up file upload button
            uploadBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Handle file selection
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    fileNameDisplay.textContent = "Selected file: " + file.name;
                    processFile(file);
                }
            });
            
            // Handle drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    fileInput.files = e.dataTransfer.files;
                    fileNameDisplay.textContent = "Selected file: " + file.name;
                    processFile(file);
                }
            });
            
            // Use sample data button
            sampleDataBtn.addEventListener('click', function() {
                loadSampleData();
            });
            
            function processFile(file) {
                if (file.type !== 'application/json') {
                    alert('Please upload a JSON file');
                    return;
                }
                
                showLoading();
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data) && data.length > 0) {
                            visualizeData(data);
                        } else {
                            alert('Invalid data format. Expected an array of netstat records.');
                            hideLoading();
                            showNoDataMessage();
                        }
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        alert('Error parsing JSON file. Please ensure it\'s a valid JSON file.');
                        hideLoading();
                        showNoDataMessage();
                    }
                };
                
                reader.onerror = function() {
                    alert('Error reading file');
                    hideLoading();
                    showNoDataMessage();
                };
                
                reader.readAsText(file);
            }
            
            function loadSampleData() {
                showLoading();
                
                // Sample data based on the provided netstat output
                const sampleData = [
                    {
                        "timestamp": "2025-04-21 01:56:57",
                        "states": {"LISTEN": 6, "ESTABLISHED": 2},
                        "ports": {"5355": 2, "53": 1, "22": 3, "80": 0},
                        "connections": 8,
                        "http_connections": 0,
                        "ssh_connections": 2,
                        "syn_recv_connections": 0,
                        "unique_web_sources": 0,
                        "web_sources": []
                    },
                    {
                        "timestamp": "2025-04-21 01:56:58",
                        "states": {"LISTEN": 6, "ESTABLISHED": 2},
                        "ports": {"5355": 2, "53": 1, "22": 3, "80": 0},
                        "connections": 8,
                        "http_connections": 0,
                        "ssh_connections": 2,
                        "syn_recv_connections": 0,
                        "unique_web_sources": 0,
                        "web_sources": []
                    },
                    {
                        "timestamp": "2025-04-21 01:56:59",
                        "states": {"LISTEN": 6, "ESTABLISHED": 2},
                        "ports": {"5355": 2, "53": 1, "22": 3, "80": 0},
                        "connections": 8,
                        "http_connections": 0,
                        "ssh_connections": 2,
                        "syn_recv_connections": 0,
                        "unique_web_sources": 0,
                        "web_sources": []
                    },
                    {
                        "timestamp": "2025-04-21 01:57:00",
                        "states": {"LISTEN": 6, "ESTABLISHED": 122},
                        "ports": {"5355": 2, "53": 1, "22": 3, "80": 120},
                        "connections": 128,
                        "http_connections": 120,
                        "ssh_connections": 2,
                        "syn_recv_connections": 0,
                        "unique_web_sources": 1,
                        "web_sources": ["10.1.1.4"]
                    }
                ];
                
                fileNameDisplay.textContent = "Using sample data";
                setTimeout(() => {
                    visualizeData(sampleData);
                }, 500);
            }
            
            function showLoading() {
                loadingDisplay.classList.remove('hide');
                dataVisualization.classList.add('hide');
                noDataMessage.classList.add('hide');
            }
            
            function hideLoading() {
                loadingDisplay.classList.add('hide');
            }
            
            function showNoDataMessage() {
                noDataMessage.classList.remove('hide');
                dataVisualization.classList.add('hide');
            }
            
            function showDataVisualization() {
                dataVisualization.classList.remove('hide');
                noDataMessage.classList.add('hide');
            }
            
            function visualizeData(data) {
                // Clear previous charts if they exist
                destroyCharts();
                
                // Clear previous table data
                const tableBody = document.getElementById('connectionTable').querySelector('tbody');
                tableBody.innerHTML = '';
                
                // Update statistics and create visualizations
                updateStats(data);
                createStateChart(data);
                createPortChart(data);
                createServiceChart(data);
                createSynRecvChart(data);
                createUniqueSourcesChart(data);
                populateTable(data);
                analyzeAttack(data);
                
                // Hide loading and show visualizations
                hideLoading();
                showDataVisualization();
            }
            
            function destroyCharts() {
                if (statesChart) statesChart.destroy();
                if (portsChart) portsChart.destroy();
                if (serviceChart) serviceChart.destroy();
                if (synRecvChart) synRecvChart.destroy();
                if (uniqueSourcesChart) uniqueSourcesChart.destroy();
            }
        });
        
        function updateStats(data) {
            // Update summary statistics
            document.getElementById('total-timestamps').textContent = data.length;
            
            const maxConnections = Math.max(...data.map(d => d.connections));
            document.getElementById('max-connections').textContent = maxConnections;
            
            const maxSynRecv = Math.max(...data.map(d => d.syn_recv_connections));
            document.getElementById('max-syn-recv').textContent = maxSynRecv;
            
            // Get unique IPs across all timestamps
            const allIps = new Set();
            data.forEach(d => {
                if (d.web_sources && Array.isArray(d.web_sources)) {
                    d.web_sources.forEach(ip => allIps.add(ip));
                }
            });
            document.getElementById('unique-ips').textContent = allIps.size;
        }
        
        function createStateChart(data) {
            const ctx = document.getElementById('statesChart').getContext('2d');
            
            // Extract all unique states
            const allStates = new Set();
            data.forEach(d => {
                if (d.states) {
                    Object.keys(d.states).forEach(state => allStates.add(state));
                }
            });
            
            // Prepare datasets
            const datasets = Array.from(allStates).map((state, index) => {
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                return {
                    label: state,
                    data: data.map(d => (d.states && d.states[state]) || 0),
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length],
                    borderWidth: 1
                };
            });
            
            statesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.timestamp),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function createPortChart(data) {
            const ctx = document.getElementById('portsChart').getContext('2d');
            
            // Extract all unique ports
            const allPorts = new Set();
            data.forEach(d => {
                if (d.ports) {
                    Object.keys(d.ports).forEach(port => allPorts.add(port));
                }
            });
            
            // Prepare datasets
            const datasets = Array.from(allPorts).map((port, index) => {
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                return {
                    label: `Port ${port}`,
                    data: data.map(d => (d.ports && d.ports[port]) || 0),
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length],
                    borderWidth: 1
                };
            });
            
            portsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.timestamp),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function createServiceChart(data) {
            const ctx = document.getElementById('serviceChart').getContext('2d');
            
            const httpDataset = {
                label: 'HTTP Connections',
                data: data.map(d => d.http_connections || 0),
                backgroundColor: 'rgba(52, 152, 219, 0.5)',
                borderColor: '#3498db',
                borderWidth: 1
            };
            
            const sshDataset = {
                label: 'SSH Connections',
                data: data.map(d => d.ssh_connections || 0),
                backgroundColor: 'rgba(46, 204, 113, 0.5)',
                borderColor: '#2ecc71',
                borderWidth: 1
            };
            
            serviceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.timestamp),
                    datasets: [httpDataset, sshDataset]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function createSynRecvChart(data) {
            const ctx = document.getElementById('synRecvChart').getContext('2d');
            
            synRecvChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.timestamp),
                    datasets: [{
                        label: 'SYN_RECV Connections',
                        data: data.map(d => d.syn_recv_connections || 0),
                        backgroundColor: 'rgba(231, 76, 60, 0.5)',
                        borderColor: '#e74c3c',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function createUniqueSourcesChart(data) {
            const ctx = document.getElementById('uniqueSourcesChart').getContext('2d');
            
            uniqueSourcesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.timestamp),
                    datasets: [{
                        label: 'Unique Source IPs',
                        data: data.map(d => d.unique_web_sources || 0),
                        backgroundColor: 'rgba(155, 89, 182, 0.5)',
                        borderColor: '#9b59b6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        function populateTable(data) {
            const tableBody = document.getElementById('connectionTable').querySelector('tbody');
            tableBody.innerHTML = ''; // Clear previous data
            
            data.forEach(d => {
                const row = document.createElement('tr');
                
                const timestampCell = document.createElement('td');
                timestampCell.textContent = d.timestamp;
                row.appendChild(timestampCell);
                
                const connectionsCell = document.createElement('td');
                connectionsCell.textContent = d.connections || 0;
                row.appendChild(connectionsCell);
                
                const httpCell = document.createElement('td');
                httpCell.textContent = d.http_connections || 0;
                row.appendChild(httpCell);
                
                const sshCell = document.createElement('td');
                sshCell.textContent = d.ssh_connections || 0;
                row.appendChild(sshCell);
                
                const synRecvCell = document.createElement('td');
                synRecvCell.textContent = d.syn_recv_connections || 0;
                row.appendChild(synRecvCell);
                
                const uniqueSourcesCell = document.createElement('td');
                uniqueSourcesCell.textContent = d.unique_web_sources || 0;
                row.appendChild(uniqueSourcesCell);
                
                tableBody.appendChild(row);
            });
        }
        
        function analyzeAttack(data) {
            const analysisEl = document.getElementById('attack-analysis');
            
            if (data.length < 2) {
                analysisEl.innerHTML = "<h3>Attack Analysis</h3><p>Insufficient data for analysis. Need at least two data points.</p>";
                return;
            }
            
            // Look for signs of attack
            const lastDataPoint = data[data.length - 1];
            const firstDataPoint = data[0];
            
            const httpIncrease = (lastDataPoint.http_connections || 0) - (firstDataPoint.http_connections || 0);
            const isSingleSource = (lastDataPoint.unique_web_sources || 0) <= 1 && (lastDataPoint.http_connections || 0) > 100;
            const hasSynRecv = (lastDataPoint.syn_recv_connections || 0) > 10;
            
            let analysisHTML = "<h3>Attack Analysis</h3>";
            
            if (httpIncrease > 100 && isSingleSource) {
                analysisHTML += `
                    <p><strong>HTTP Flood Attack Detected</strong></p>
                    <p>The data shows signs of an HTTP flood attack with the following characteristics:</p>
                    <ul>
                        <li>Sudden increase from ${firstDataPoint.http_connections || 0} to ${lastDataPoint.http_connections || 0} HTTP connections</li>
                        <li>All connections coming from a single IP: ${(lastDataPoint.web_sources && lastDataPoint.web_sources.length > 0) ? lastDataPoint.web_sources.join(', ') : 'unknown'}</li>
                        <li>Attack started at ${data.find(d => (d.http_connections || 0) > 10)?.timestamp || 'unknown'}</li>
                    </ul>
                    <p>This appears to be a layer 7 (application layer) DDoS attack targeting the web server.</p>
                `;
            } else if (hasSynRecv) {
                analysisHTML += `
                    <p><strong>SYN Flood Attack Detected</strong></p>
                    <p>The data shows signs of a SYN flood attack with ${lastDataPoint.syn_recv_connections || 0} half-open connections.</p>
                `;
            } else if (httpIncrease > 50) {
                analysisHTML += `
                    <p><strong>Unusual HTTP Traffic Detected</strong></p>
                    <p>The data shows a significant increase in HTTP connections from ${firstDataPoint.http_connections || 0} to ${lastDataPoint.http_connections || 0}.</p>
                    <p>This could be legitimate traffic or the beginning of an attack. Further monitoring is recommended.</p>
                `;
            } else {
                analysisHTML += `
                    <p>Based on the analyzed data:</p>
                    <ul>
                        <li>Normal SSH connections: ${lastDataPoint.ssh_connections || 0}</li>
                        <li>HTTP connections: ${lastDataPoint.http_connections || 0} (from ${lastDataPoint.unique_web_sources || 0} unique source(s))</li>
                        <li>SYN_RECV connections: ${lastDataPoint.syn_recv_connections || 0}</li>
                    </ul>
                    <p>No obvious attack patterns detected in the current data.</p>
                `;
            }
            
            analysisEl.innerHTML = analysisHTML;
        }
    </script>
</body>
</html>
